{% extends "base.html" %}

{% block title %}{{ player.ll_username if player else "Player Not Found" }} - LL Analytics{% endblock %}

{% block content %}
{% if not player %}
<div class="bg-slate-900 border border-red-800/30 rounded-lg p-4">
    <p class="text-red-400">{{ error or "Player not found" }}</p>
    <a href="/" class="text-emerald-400 hover:text-emerald-300 mt-2 inline-block">Back to Home</a>
</div>
{% else %}

<div x-data="{ activeTab: 'overview', expandedMetric: null }">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-100">{{ player.ll_username }}</h1>
            {% if player.display_name and player.display_name != player.ll_username %}
            <span class="text-slate-400">({{ player.display_name }})</span>
            {% endif %}
        </div>
        {% if season %}
        <p class="text-slate-400 mt-1">Season {{ season.season_number }} Performance</p>
        {% endif %}
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <div class="text-sm text-slate-400">Total Correct</div>
            <div class="text-2xl font-bold text-emerald-400">{{ totals.tca or 0 }}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <div class="text-sm text-slate-400">Questions Answered</div>
            <div class="text-2xl font-bold text-gray-100">{{ totals.total_q or 0 }}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <div class="text-sm text-slate-400">CA%</div>
            <div class="text-2xl font-bold text-emerald-400">
                {% if totals.total_q and totals.total_q > 0 %}
                    {{ "%.1f"|format((totals.tca or 0) / totals.total_q * 100) }}%
                {% else %}
                    -
                {% endif %}
            </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <div class="text-sm text-slate-400">Match Days</div>
            <div class="text-2xl font-bold text-gray-100">{{ h2h_matches|length if h2h_matches else match_results|length }}</div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="border-b border-slate-700 mb-6">
        <nav class="flex space-x-8">
            <button
                @click="activeTab = 'overview'"
                :class="activeTab === 'overview' ? 'border-emerald-400 text-emerald-400' : 'border-transparent text-slate-400 hover:text-gray-200'"
                class="py-2 px-1 border-b-2 font-medium text-sm"
            >Overview</button>
            <button
                @click="activeTab = 'metrics'"
                :class="activeTab === 'metrics' ? 'border-emerald-400 text-emerald-400' : 'border-transparent text-slate-400 hover:text-gray-200'"
                class="py-2 px-1 border-b-2 font-medium text-sm"
            >Metrics</button>
            <button
                @click="activeTab = 'categories'"
                :class="activeTab === 'categories' ? 'border-emerald-400 text-emerald-400' : 'border-transparent text-slate-400 hover:text-gray-200'"
                class="py-2 px-1 border-b-2 font-medium text-sm"
            >Categories</button>
            <button
                @click="activeTab = 'matches'"
                :class="activeTab === 'matches' ? 'border-emerald-400 text-emerald-400' : 'border-transparent text-slate-400 hover:text-gray-200'"
                class="py-2 px-1 border-b-2 font-medium text-sm"
            >Match History</button>
        </nav>
    </div>

    <!-- Overview Tab -->
    <div x-show="activeTab === 'overview'" class="space-y-6">
        <!-- Quick Links -->
        {% if season %}
        <div class="flex gap-2">
            <a href="/player/{{ player.ll_username }}/heatmap?season={{ season.season_number }}"
               class="inline-flex items-center px-3 py-1.5 bg-emerald-900/40 text-emerald-400 text-sm rounded-md hover:bg-emerald-900/60">
                View Performance Heatmap &rarr;
            </a>
        </div>
        {% endif %}

        <!-- Match Day Chart -->
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <h3 class="text-lg font-medium text-gray-100 mb-4">Performance by Match Day</h3>
            <canvas id="matchDayChart" height="200"></canvas>
        </div>

        <!-- All Category Stats -->
        {% if category_stats %}
        <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
            <h3 class="text-lg font-medium text-gray-100 mb-4">Category Performance (Lifetime)</h3>
            <div class="space-y-2 max-h-96 overflow-y-auto">
                {% for cat in category_stats %}
                <div class="flex items-center">
                    <span class="w-36 text-sm text-slate-400 truncate" title="{{ cat.name }}">{{ cat.name }}</span>
                    <div class="flex-1 mx-3">
                        <div class="bg-slate-700 rounded-full h-3">
                            <div class="{% if (cat.correct_pct or 0) >= 0.6 %}bg-emerald-500{% elif (cat.correct_pct or 0) >= 0.4 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-3 rounded-full" style="width: {{ (cat.correct_pct or 0) * 100 }}%"></div>
                        </div>
                    </div>
                    <span class="text-sm font-medium text-gray-100 w-12 text-right">{{ "%.0f"|format((cat.correct_pct or 0) * 100) }}%</span>
                    <span class="text-xs text-slate-500 w-16 text-right">({{ cat.total_questions or 0 }})</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Metrics Tab -->
    <div x-show="activeTab === 'metrics'" class="space-y-4">
        <p class="text-sm text-slate-400 mb-4">
            Click on any metric card to see detailed breakdown and explanation.
        </p>

        {% for metric_id, metric in metrics.items() %}
        <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
            <!-- Metric Header (always visible) -->
            <button
                @click="expandedMetric = expandedMetric === '{{ metric_id }}' ? null : '{{ metric_id }}'"
                class="w-full px-4 py-4 flex items-center justify-between hover:bg-slate-800 transition-colors"
            >
                <div class="flex-1 text-left">
                    <div class="flex items-center gap-2">
                        <h3 class="font-medium text-gray-100">{{ metric.name }}</h3>
                        <span class="group relative">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-800 border border-slate-700 text-gray-100 text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                {{ metric.description }}
                            </span>
                        </span>
                    </div>
                    {% if metric.result %}
                    <p class="text-sm text-slate-500 mt-1">{{ metric.description }}</p>
                    {% elif metric.error %}
                    <p class="text-sm text-red-400 mt-1">Error calculating metric</p>
                    {% endif %}
                </div>

                <!-- Metric Value -->
                <div class="flex items-center gap-4">
                    {% if metric.result and metric.result.data %}
                        {% if metric.result.data.get('total_surprise') is not none %}
                        <span class="text-xl font-bold {% if metric.result.data.get('total_surprise', 0) > 0 %}text-emerald-400{% elif metric.result.data.get('total_surprise', 0) < 0 %}text-red-400{% else %}text-slate-400{% endif %}">
                            {{ "%+.2f"|format(metric.result.data.get('total_surprise', 0)) }}
                        </span>
                        {% elif metric.result.data.get('early') is not none %}
                        <span class="text-xl font-bold {% if metric.result.data.get('z_score', 0) > 1.5 %}text-orange-400{% elif metric.result.data.get('z_score', 0) < -1.5 %}text-blue-400{% else %}text-slate-400{% endif %}">
                            {% if metric.result.data.get('z_score', 0) > 0 %}+{% endif %}{{ "%.2f"|format(metric.result.data.get('z_score', 0)) }} z
                        </span>
                        {% elif metric.result.data.get('total_luck') is not none %}
                        <span class="text-xl font-bold {% if metric.result.data.get('total_luck', 0) > 0 %}text-emerald-400{% elif metric.result.data.get('total_luck', 0) < 0 %}text-red-400{% else %}text-slate-400{% endif %}">
                            {{ "%+.1f"|format(metric.result.data.get('total_luck', 0)) }}
                        </span>
                        {% elif metric.result.data.get('roi') is not none %}
                        <span class="text-xl font-bold {% if metric.result.data.get('roi', 0) > 0 %}text-emerald-400{% elif metric.result.data.get('roi', 0) < 0 %}text-red-400{% else %}text-slate-400{% endif %}">
                            {{ "%+d"|format(metric.result.data.get('roi', 0)) }} pts
                        </span>
                        {% elif metric.result.data.get('breadth_score') is not none %}
                        <span class="text-xl font-bold {% if metric.result.data.get('breadth_score', 0) >= 0.7 %}text-emerald-400{% elif metric.result.data.get('breadth_score', 0) >= 0.4 %}text-yellow-400{% else %}text-red-400{% endif %}">
                            {{ "%.2f"|format(metric.result.data.get('breadth_score', 0)) }}
                        </span>
                        {% endif %}
                    {% endif %}

                    <!-- Expand/collapse arrow -->
                    <svg
                        class="w-5 h-5 text-slate-500 transition-transform"
                        :class="expandedMetric === '{{ metric_id }}' ? 'rotate-180' : ''"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>

            <!-- Expanded Details -->
            <div
                x-show="expandedMetric === '{{ metric_id }}'"
                x-collapse
                class="border-t border-slate-700 px-4 py-4 bg-slate-800/50"
            >
                {% if metric.error %}
                <p class="text-red-400">{{ metric.error }}</p>
                {% elif metric.result and metric.result.data %}

                <!-- Surprise Metric Details -->
                {% if metric_id == 'surprise' and metric.result.data.get('total_surprise') is not none %}
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-emerald-400">{{ "%.2f"|format(metric.result.data.get('total_surprise', 0)) }}</div>
                            <div class="text-sm text-slate-400">Total Surprise</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ "%.3f"|format(metric.result.data.get('avg_surprise', 0)) }}</div>
                            <div class="text-sm text-slate-400">Avg per Question</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ metric.result.data.get('questions_analyzed', 0) }}</div>
                            <div class="text-sm text-slate-400">Questions Analyzed</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">How Surprise is Calculated</h4>
                        <p class="text-sm text-slate-400">
                            For each question, we calculate an "expected probability" of you answering correctly based on:
                        </p>
                        <ul class="text-sm text-slate-400 list-disc ml-5 mt-2 space-y-1">
                            <li>Your historical performance in that category</li>
                            <li>The question's difficulty (rundle-wide correct %)</li>
                        </ul>
                        <p class="text-sm text-slate-400 mt-2">
                            <strong class="text-gray-200">Positive surprise</strong> means you performed better than expected.
                            <strong class="text-gray-200">Negative surprise</strong> means you underperformed expectations.
                        </p>
                    </div>

                    <div class="mt-4 flex gap-2">
                        <a href="/player/{{ player.ll_username }}/surprise?season={{ season.season_number }}"
                           class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700">
                            View Per-Question Breakdown
                            <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </a>
                    </div>

                    {% if metric.result.data.get('by_day') %}
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">Surprise by Match Day</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="border-b border-slate-700">
                                        <th class="text-left py-2 px-2 text-slate-400">Day</th>
                                        <th class="text-right py-2 px-2 text-slate-400">Surprise</th>
                                        <th class="text-right py-2 px-2 text-slate-400">Questions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for day in metric.result.data.get('by_day', []) %}
                                    <tr class="border-b border-slate-800">
                                        <td class="py-2 px-2 text-gray-100">Day {{ day.get('match_day', '?') }}</td>
                                        <td class="text-right py-2 px-2 {% if day.get('surprise', 0) > 0 %}text-emerald-400{% elif day.get('surprise', 0) < 0 %}text-red-400{% endif %}">
                                            {{ "%+.2f"|format(day.get('surprise', 0)) }}
                                        </td>
                                        <td class="text-right py-2 px-2 text-slate-500">{{ day.get('questions', 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Late Spike Metric Details -->
                {% elif metric_id == 'late_spike' and metric.result.data.get('early') is not none %}
                <div class="space-y-4">
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ "%.3f"|format(metric.result.data.get('early', {}).get('avg_surprise', 0)) }}</div>
                            <div class="text-sm text-slate-400">Early Avg (Days 1-10)</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ "%.3f"|format(metric.result.data.get('late', {}).get('avg_surprise', 0)) }}</div>
                            <div class="text-sm text-slate-400">Late Avg (Days 20-25)</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('delta', 0) > 0 %}text-emerald-400{% elif metric.result.data.get('delta', 0) < 0 %}text-red-400{% endif %}">
                                {{ "%+.3f"|format(metric.result.data.get('delta', 0)) }}
                            </div>
                            <div class="text-sm text-slate-400">Delta</div>
                        </div>
                        <div>
                            {% if metric.result.data.get('z_score') is not none %}
                            <div class="text-2xl font-bold {% if metric.result.data.get('z_score', 0) > 1.5 %}text-orange-400{% elif metric.result.data.get('z_score', 0) < -1.5 %}text-blue-400{% endif %}">
                                {{ "%.2f"|format(metric.result.data.get('z_score', 0)) }}
                            </div>
                            {% else %}
                            <div class="text-2xl font-bold text-slate-500">N/A</div>
                            {% endif %}
                            <div class="text-sm text-slate-400">Z-Score</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">What This Means</h4>
                        <p class="text-sm text-slate-400">
                            This metric compares your average surprise (performance vs expectation) in the early season
                            (days 1-10) versus the late season (days 20-25).
                        </p>
                        <ul class="text-sm text-slate-400 list-disc ml-5 mt-2 space-y-1">
                            <li><strong class="text-gray-200">Positive delta:</strong> You performed better than expected late in the season</li>
                            <li><strong class="text-gray-200">Z-Score > 1.96:</strong> Statistically significant improvement</li>
                            <li><strong class="text-gray-200">Z-Score < -1.96:</strong> Statistically significant decline</li>
                        </ul>
                        <p class="text-sm text-slate-500 mt-2">
                            Based on {{ metric.result.data.get('early', {}).get('questions', 0) }} early questions and
                            {{ metric.result.data.get('late', {}).get('questions', 0) }} late questions.
                        </p>
                    </div>
                </div>
                <!-- Luck Metric -->
                {% elif metric_id == 'luck' and metric.result.data.get('total_luck') is not none %}
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('total_luck', 0) > 0 %}text-emerald-400{% else %}text-red-400{% endif %}">
                                {{ "%+.1f"|format(metric.result.data.get('total_luck', 0)) }}
                            </div>
                            <div class="text-sm text-slate-400">Total Luck</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('total_weighted_luck', 0) > 0 %}text-emerald-400{% else %}text-red-400{% endif %}">
                                {{ "%+.1f"|format(metric.result.data.get('total_weighted_luck', 0)) }}
                            </div>
                            <div class="text-sm text-slate-400">Weighted Luck</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ metric.result.data.get('matches_played', 0) }}</div>
                            <div class="text-sm text-slate-400">Matches</div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-400">
                        {% if metric.result.data.get('total_luck', 0) < -10 %}
                        Opponents have consistently overperformed against you - that's unlucky!
                        {% elif metric.result.data.get('total_luck', 0) > 10 %}
                        Opponents have consistently underperformed against you - that's lucky!
                        {% else %}
                        Opponent performance has been roughly average against you.
                        {% endif %}
                    </p>
                    <a href="/luck/{{ player.ll_username }}?season={{ season.season_number }}"
                       class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-md hover:bg-emerald-700">
                        View Full Luck Analysis
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </a>
                </div>

                <!-- Defense Strategy Metric -->
                {% elif metric_id == 'defense' and metric.result.data.get('roi') is not none %}
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('roi', 0) > 0 %}text-emerald-400{% elif metric.result.data.get('roi', 0) < 0 %}text-red-400{% else %}text-slate-400{% endif %}">
                                {{ "%+d"|format(metric.result.data.get('roi', 0)) }}
                            </div>
                            <div class="text-sm text-slate-400">Defense ROI</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-emerald-400">{{ metric.result.data.get('total_points_saved', 0) }}</div>
                            <div class="text-sm text-slate-400">Points Saved</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-400">{{ metric.result.data.get('total_points_lost', 0) }}</div>
                            <div class="text-sm text-slate-400">Points Lost</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('effectiveness', 0) > 0.1 %}text-emerald-400{% elif metric.result.data.get('effectiveness', 0) < -0.1 %}text-red-400{% else %}text-slate-400{% endif %}">
                                {{ "%.1f"|format((metric.result.data.get('effectiveness', 0)) * 100) }}%
                            </div>
                            <div class="text-sm text-slate-400">Effectiveness</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center border-t border-slate-700 pt-4">
                        <div>
                            <div class="text-lg font-medium text-gray-100">{{ "%.0f"|format((metric.result.data.get('high_defense_miss_rate', 0)) * 100) }}%</div>
                            <div class="text-xs text-slate-500">Opp Miss Rate (High Def)</div>
                        </div>
                        <div>
                            <div class="text-lg font-medium text-gray-100">{{ "%.0f"|format((metric.result.data.get('baseline_miss_rate', 0)) * 100) }}%</div>
                            <div class="text-xs text-slate-500">Opp Miss Rate (Baseline)</div>
                        </div>
                        <div>
                            <div class="text-lg font-medium text-gray-100">{{ "%.2f"|format(metric.result.data.get('allocation_gini', 0)) }}</div>
                            <div class="text-xs text-slate-500">Allocation Gini</div>
                        </div>
                        <div>
                            <div class="text-lg font-medium text-gray-100">{{ metric.result.data.get('questions_analyzed', 0) }}</div>
                            <div class="text-xs text-slate-500">Questions Analyzed</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">How Defense ROI Works</h4>
                        <p class="text-sm text-slate-400">
                            Measures how effectively you allocate defensive points against opponents.
                        </p>
                        <ul class="text-sm text-slate-400 list-disc ml-5 mt-2 space-y-1">
                            <li><strong class="text-gray-200">ROI</strong> = Points saved (opponent missed) minus points lost (opponent got it right)</li>
                            <li><strong class="text-gray-200">Effectiveness</strong> = Difference in opponent miss rate on high-defense vs baseline questions</li>
                            <li><strong class="text-gray-200">Gini</strong> = How concentrated your defense allocation is (higher = more focused)</li>
                        </ul>
                    </div>
                </div>

                <!-- Breadth Metric -->
                {% elif metric_id == 'breadth' and metric.result.data.get('breadth_score') is not none %}
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold {% if metric.result.data.get('breadth_score', 0) >= 0.7 %}text-emerald-400{% elif metric.result.data.get('breadth_score', 0) >= 0.4 %}text-yellow-400{% else %}text-red-400{% endif %}">
                                {{ "%.3f"|format(metric.result.data.get('breadth_score', 0)) }}
                            </div>
                            <div class="text-sm text-slate-400">Breadth Score</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ "%.3f"|format(metric.result.data.get('stdev', 0)) }}</div>
                            <div class="text-sm text-slate-400">Std Deviation</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-100">{{ metric.result.data.get('categories_used', 0) }}</div>
                            <div class="text-sm text-slate-400">Categories</div>
                        </div>
                    </div>

                    {% if metric.result.data.get('strongest') or metric.result.data.get('weakest') %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        {% if metric.result.data.get('strongest') %}
                        <div>
                            <h4 class="font-medium text-gray-100 mb-2">Strongest Categories</h4>
                            <div class="space-y-2">
                                {% for cat in metric.result.data.get('strongest', []) %}
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">{{ cat.name }}</span>
                                    <span class="text-sm font-medium text-emerald-400">{{ "%.0f"|format(cat.pct) }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if metric.result.data.get('weakest') %}
                        <div>
                            <h4 class="font-medium text-gray-100 mb-2">Weakest Categories</h4>
                            <div class="space-y-2">
                                {% for cat in metric.result.data.get('weakest', []) %}
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-300">{{ cat.name }}</span>
                                    <span class="text-sm font-medium text-red-400">{{ "%.0f"|format(cat.pct) }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if metric.result.data.get('profile') %}
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">Full Category Profile</h4>
                        <div class="space-y-1.5 max-h-64 overflow-y-auto">
                            {% for cat in metric.result.data.get('profile', []) %}
                            <div class="flex items-center">
                                <span class="w-36 text-sm text-slate-400 truncate" title="{{ cat.name }}">{{ cat.name }}</span>
                                <div class="flex-1 mx-3">
                                    <div class="bg-slate-700 rounded-full h-2.5">
                                        <div class="{% if cat.pct >= 60 %}bg-emerald-500{% elif cat.pct >= 40 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-2.5 rounded-full" style="width: {{ cat.pct }}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm font-medium text-gray-100 w-12 text-right">{{ "%.0f"|format(cat.pct) }}%</span>
                                <span class="text-xs text-slate-500 w-10 text-right">({{ cat.questions }})</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mt-4">
                        <h4 class="font-medium text-gray-100 mb-2">What Breadth Measures</h4>
                        <p class="text-sm text-slate-400">
                            Breadth score measures how balanced your performance is across categories.
                        </p>
                        <ul class="text-sm text-slate-400 list-disc ml-5 mt-2 space-y-1">
                            <li><strong class="text-gray-200">1.0</strong> = Perfectly balanced across all categories</li>
                            <li><strong class="text-gray-200">0.0</strong> = Extreme variation (strong in some, weak in others)</li>
                            <li>Based on categories with 5+ questions answered</li>
                        </ul>
                    </div>
                </div>

                {% else %}
                <!-- Generic metric data display -->
                <pre class="text-xs bg-slate-800 text-slate-300 p-2 rounded overflow-x-auto">{{ metric.result.data | tojson(indent=2) }}</pre>
                {% endif %}

                {% else %}
                <p class="text-slate-500">No data available for this metric.</p>
                {% endif %}
            </div>
        </div>
        {% else %}
        <p class="text-slate-500">No metrics available.</p>
        {% endfor %}
    </div>

    <!-- Categories Tab -->
    <div x-show="activeTab === 'categories'">
        {% if category_stats %}
        <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Correct %</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Questions</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Performance</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {% for cat in category_stats %}
                    <tr class="hover:bg-slate-800">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-100">{{ cat.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-100">{{ "%.1f"|format((cat.correct_pct or 0) * 100) }}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-400">{{ cat.total_questions or 0 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-32 bg-slate-700 rounded-full h-2">
                                <div class="{% if (cat.correct_pct or 0) >= 0.7 %}bg-emerald-500{% elif (cat.correct_pct or 0) >= 0.5 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-2 rounded-full" style="width: {{ (cat.correct_pct or 0) * 100 }}%"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-slate-500">No category data available.</p>
        {% endif %}
    </div>

    <!-- Matches Tab -->
    <div x-show="activeTab === 'matches'">
        {% if h2h_matches %}
        <!-- Head-to-head match results from matches table -->
        <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Day</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase">Opponent</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase">Result</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase">Score</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase">TCA</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {% for match in h2h_matches %}
                    <tr class="hover:bg-slate-800">
                        <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-100">{{ match.match_day }}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <a href="/player/{{ match.opponent }}" class="text-emerald-400 hover:text-emerald-300">{{ match.opponent }}</a>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if match.result == 'W' %}bg-emerald-900/40 text-emerald-400
                                {% elif match.result == 'L' %}bg-red-900/40 text-red-400
                                {% else %}bg-slate-700 text-slate-300{% endif %}">
                                {{ match.result }}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-gray-100">
                            {{ match.my_score }}-{{ match.opp_score }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-slate-400">{{ match.my_tca }}/6</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif match_results %}
        <!-- Per-question results from answers table -->
        <div class="bg-slate-900 border border-slate-800 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Match Day</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Correct</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase">Percentage</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {% for match in match_results %}
                    <tr class="hover:bg-slate-800">
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-100">Day {{ match.match_day }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-100">{{ match.correct }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-slate-400">{{ match.questions }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set pct = match.correct / match.questions * 100 if match.questions > 0 else 0 %}
                            <span class="{% if pct >= 83 %}text-emerald-400{% elif pct >= 50 %}text-yellow-400{% else %}text-red-400{% endif %} font-medium">
                                {{ "%.0f"|format(pct) }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-slate-500">No match history available.</p>
        {% endif %}
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Match day performance chart - use h2h_matches if available, else match_results
    const h2hData = {{ h2h_matches | tojson }};
    const matchData = {{ match_results | tojson }};

    const ctx = document.getElementById('matchDayChart');
    if (!ctx) return;

    if (h2hData && h2hData.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: h2hData.map(m => 'Day ' + m.match_day),
                datasets: [{
                    label: 'TCA (Correct Answers)',
                    data: h2hData.map(m => m.my_tca),
                    backgroundColor: 'rgba(52, 211, 153, 0.7)',
                    borderColor: 'rgb(52, 211, 153)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 6,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    } else if (matchData && matchData.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: matchData.map(m => 'Day ' + m.match_day),
                datasets: [{
                    label: 'Correct Answers',
                    data: matchData.map(m => m.correct),
                    backgroundColor: 'rgba(52, 211, 153, 0.7)',
                    borderColor: 'rgb(52, 211, 153)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 6,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
