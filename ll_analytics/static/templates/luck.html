{% extends "base.html" %}

{% block title %}{{ username }}'s Luck Analysis - LL Analytics{% endblock %}

{% block content %}
<div x-data="luckAnalysis()" x-init="init()">
    <!-- Header -->
    <div class="mb-6">
        <nav class="text-sm mb-2">
            <a href="/" class="text-indigo-600 hover:underline">Home</a>
            <span class="text-gray-400 mx-2">/</span>
            <span class="text-gray-600">Luck Analysis</span>
        </nav>
        <h1 class="text-3xl font-bold text-gray-900">
            <span x-show="data.total_luck < -15" class="text-red-600">Brutally Unlucky:</span>
            <span x-show="data.total_luck >= -15 && data.total_luck < -5" class="text-orange-600">Unlucky:</span>
            <span x-show="data.total_luck >= -5 && data.total_luck <= 5" class="text-gray-600">Average Luck:</span>
            <span x-show="data.total_luck > 5 && data.total_luck <= 15" class="text-green-600">Lucky:</span>
            <span x-show="data.total_luck > 15" class="text-emerald-600">Incredibly Lucky:</span>
            {{ username }}
        </h1>
        <p class="text-gray-600 mt-1">Season {{ season }} Opponent Performance Analysis</p>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="text-gray-500 mt-4">Analyzing opponent variance...</p>
    </div>

    <!-- Main Content -->
    <div x-show="!loading">
        <!-- Big Luck Score -->
        <div class="bg-gradient-to-r from-red-500 to-red-700 rounded-xl shadow-lg p-8 mb-8 text-white" x-show="data.total_luck < -15">
            <div class="text-center">
                <div class="text-6xl font-bold mb-2" x-text="data.total_luck?.toFixed(1)"></div>
                <div class="text-xl opacity-90">Total Luck Score</div>
                <p class="mt-4 text-lg opacity-80">
                    Opponents overperformed by an average of <span class="font-bold" x-text="Math.abs(data.avg_luck_per_match || 0).toFixed(2)"></span> TCA per match
                </p>
            </div>
        </div>

        <div class="bg-gradient-to-r from-gray-500 to-gray-700 rounded-xl shadow-lg p-8 mb-8 text-white" x-show="data.total_luck >= -15 && data.total_luck <= 15">
            <div class="text-center">
                <div class="text-6xl font-bold mb-2" x-text="(data.total_luck > 0 ? '+' : '') + data.total_luck?.toFixed(1)"></div>
                <div class="text-xl opacity-90">Total Luck Score</div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-green-500 to-green-700 rounded-xl shadow-lg p-8 mb-8 text-white" x-show="data.total_luck > 15">
            <div class="text-center">
                <div class="text-6xl font-bold mb-2" x-text="'+' + data.total_luck?.toFixed(1)"></div>
                <div class="text-xl opacity-90">Total Luck Score</div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold" :class="data.total_luck < 0 ? 'text-red-600' : 'text-green-600'"
                     x-text="(data.total_luck > 0 ? '+' : '') + (data.total_luck?.toFixed(1) || '0')"></div>
                <div class="text-sm text-gray-500">Raw Luck</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold" :class="data.total_weighted_luck < 0 ? 'text-red-600' : 'text-green-600'"
                     x-text="(data.total_weighted_luck > 0 ? '+' : '') + (data.total_weighted_luck?.toFixed(1) || '0')"></div>
                <div class="text-sm text-gray-500">Surprise-Weighted</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold text-gray-900" x-text="data.matches_played || 0"></div>
                <div class="text-sm text-gray-500">Matches Played</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-3xl font-bold" :class="rankColor" x-text="'#' + (rank || '?') + '/' + (leaderboard.length || '?')"></div>
                <div class="text-sm text-gray-500">Luck Rank (1=Luckiest)</div>
            </div>
        </div>

        <!-- Explanation -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
            <h3 class="font-medium text-blue-900 mb-2">How Luck is Calculated</h3>
            <p class="text-blue-800 text-sm">
                For each match, we compare your opponent's TCA (correct answers) to their season average.
                If opponents consistently score <strong>above</strong> their average against you, that's unlucky (negative luck).
                If they score <strong>below</strong> their average, that's lucky (positive luck).
            </p>
            <p class="text-blue-800 text-sm mt-2">
                <strong>Surprise-weighted</strong> luck gives extra weight to extreme opponent performances.
                If an opponent who averages 4 TCA suddenly gets 6 or 1, that deviation is weighted more heavily than
                a small deviation like getting 3 or 5. The formula uses z-scores: bigger deviations from average = bigger multiplier
                (opponents having career days or terrible days).
            </p>
        </div>

        <!-- Unlucky Matches Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Luck by Match Day</h3>
            <div class="h-64">
                <canvas id="luckChart"></canvas>
            </div>
        </div>

        <!-- Most Unlucky Matches -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-4 py-3 bg-red-50 border-b border-red-100">
                <h3 class="text-lg font-medium text-red-900">Most Unlucky Matches</h3>
                <p class="text-sm text-red-700">Opponents who massively overperformed against you</p>
            </div>
            <div class="divide-y divide-gray-200">
                <template x-for="match in unluckyMatches" :key="match.match_day">
                    <div class="px-4 py-4 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-medium text-gray-500" x-text="'Day ' + match.match_day"></span>
                                <span class="font-medium text-gray-900">vs <span x-text="match.opponent"></span></span>
                                <span class="px-2 py-0.5 rounded text-xs font-medium"
                                      :class="match.result === 'W' ? 'bg-green-100 text-green-800' : match.result === 'L' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'"
                                      x-text="match.result"></span>
                            </div>
                            <div class="text-sm text-gray-500 mt-1">
                                Score: <span x-text="match.your_score + '-' + match.opponent_score"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-red-600" x-text="match.luck.toFixed(2)"></div>
                            <div class="text-xs text-gray-500">
                                Opp TCA: <span class="font-medium" x-text="match.opponent_tca"></span>
                                (avg <span x-text="match.opponent_avg"></span>)
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Lucky Matches -->
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-4 py-3 bg-green-50 border-b border-green-100">
                <h3 class="text-lg font-medium text-green-900">Luckiest Matches</h3>
                <p class="text-sm text-green-700">Opponents who underperformed against you</p>
            </div>
            <div class="divide-y divide-gray-200">
                <template x-for="match in luckyMatches" :key="match.match_day">
                    <div class="px-4 py-4 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-medium text-gray-500" x-text="'Day ' + match.match_day"></span>
                                <span class="font-medium text-gray-900">vs <span x-text="match.opponent"></span></span>
                                <span class="px-2 py-0.5 rounded text-xs font-medium"
                                      :class="match.result === 'W' ? 'bg-green-100 text-green-800' : match.result === 'L' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'"
                                      x-text="match.result"></span>
                            </div>
                            <div class="text-sm text-gray-500 mt-1">
                                Score: <span x-text="match.your_score + '-' + match.opponent_score"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-green-600" x-text="'+' + match.luck.toFixed(2)"></div>
                            <div class="text-xs text-gray-500">
                                Opp TCA: <span class="font-medium" x-text="match.opponent_tca"></span>
                                (avg <span x-text="match.opponent_avg"></span>)
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Full Match History -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">All Matches</h3>
                <p class="text-sm text-gray-500">Click a row to see question-by-question breakdown</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Day</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opponent</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Result</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Score</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Opp TCA</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Opp Avg</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Luck</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="match in data.details" :key="match.match_day">
                            <tr class="hover:bg-indigo-50 cursor-pointer" @click="showMatchDetail(match.match_day)">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="match.match_day"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="match.opponent"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <span class="px-2 py-0.5 rounded text-xs font-medium"
                                          :class="match.result === 'W' ? 'bg-green-100 text-green-800' : match.result === 'L' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'"
                                          x-text="match.result"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-600" x-text="match.your_score + '-' + match.opponent_score"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-medium"
                                    :class="match.opponent_tca > match.opponent_avg ? 'text-red-600' : 'text-green-600'"
                                    x-text="match.opponent_tca"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500" x-text="match.opponent_avg"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium"
                                    :class="match.luck < 0 ? 'text-red-600' : 'text-green-600'"
                                    x-text="(match.luck > 0 ? '+' : '') + match.luck.toFixed(2)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Match Detail Modal -->
        <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showModal = false">
            <div class="flex items-center justify-center min-h-screen px-4">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black opacity-50" @click="showModal = false"></div>

                <!-- Modal Content -->
                <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto z-10">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">
                                Day <span x-text="matchDetail?.match_day"></span>:
                                <span x-text="matchDetail?.your_name"></span> vs <span x-text="matchDetail?.opponent"></span>
                            </h3>
                            <p class="text-sm text-gray-500">
                                <span :class="matchDetail?.result === 'W' ? 'text-green-600' : matchDetail?.result === 'L' ? 'text-red-600' : 'text-gray-600'"
                                      x-text="matchDetail?.result === 'W' ? 'Won' : matchDetail?.result === 'L' ? 'Lost' : 'Tied'"></span>
                                <span x-text="matchDetail?.your_score + '-' + matchDetail?.opp_score"></span>
                                (TCA: <span x-text="matchDetail?.your_tca + '-' + matchDetail?.opp_tca"></span>)
                            </p>
                        </div>
                        <button @click="showModal = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Loading -->
                    <div x-show="modalLoading" class="p-8 text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                        <p class="text-gray-500 mt-2">Loading match details...</p>
                    </div>

                    <!-- Questions Table -->
                    <div x-show="!modalLoading && matchDetail?.questions" class="p-6">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2 text-xs font-medium text-gray-500 uppercase">Q#</th>
                                    <th class="text-left py-2 text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th class="text-center py-2 text-xs font-medium text-gray-500 uppercase">CA%</th>
                                    <th class="text-center py-2 text-xs font-medium text-gray-500 uppercase">You</th>
                                    <th class="text-center py-2 text-xs font-medium text-gray-500 uppercase">Opp</th>
                                    <th class="text-center py-2 text-xs font-medium text-gray-500 uppercase">Your Cat%</th>
                                    <th class="text-center py-2 text-xs font-medium text-gray-500 uppercase">Opp Cat%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="q in matchDetail?.questions || []" :key="q.question_num">
                                    <tr>
                                        <td class="py-3 text-sm font-medium text-gray-900" x-text="q.question_num"></td>
                                        <td class="py-3 text-sm text-gray-700" x-text="q.category || 'Unknown'"></td>
                                        <td class="py-3 text-sm text-center text-gray-500" x-text="q.ca_pct ? (q.ca_pct * 100).toFixed(0) + '%' : '-'"></td>
                                        <td class="py-3 text-center">
                                            <span :class="q.your_correct ? 'text-green-600' : 'text-red-600'" class="font-bold" x-text="q.your_correct ? '✓' : '✗'"></span>
                                        </td>
                                        <td class="py-3 text-center">
                                            <span :class="q.opp_correct ? 'text-green-600' : 'text-red-600'" class="font-bold" x-text="q.opp_correct ? '✓' : '✗'"></span>
                                        </td>
                                        <td class="py-3 text-sm text-center" :class="q.your_cat_pct ? 'text-gray-700' : 'text-gray-400'" x-text="q.your_cat_pct ? q.your_cat_pct + '%' : '-'"></td>
                                        <td class="py-3 text-sm text-center" :class="q.opp_cat_pct ? 'text-gray-700' : 'text-gray-400'" x-text="q.opp_cat_pct ? q.opp_cat_pct + '%' : '-'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                        <!-- No data message -->
                        <div x-show="matchDetail?.questions?.length === 0" class="text-center py-8 text-gray-500">
                            No question-level data available for this match yet.
                            <br><span class="text-sm">Run the scraper to fetch detailed match data.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rundle Comparison -->
        <div class="mt-8 bg-white rounded-lg shadow overflow-hidden" x-show="leaderboard.length > 0">
            <div class="px-4 py-3 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Rundle Luck Rankings</h3>
                <p class="text-sm text-gray-500">How does {{ username }} compare to others?</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Player</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Luck</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Weighted</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="entry in leaderboard" :key="entry.username">
                            <tr :class="entry.username === '{{ username }}' ? 'bg-yellow-50 font-medium' : 'hover:bg-gray-50'">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="entry.rank"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm"
                                    :class="entry.username === '{{ username }}' ? 'text-indigo-600 font-bold' : 'text-gray-900'"
                                    x-text="entry.username"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right"
                                    :class="entry.total_luck < 0 ? 'text-red-600' : 'text-green-600'"
                                    x-text="(entry.total_luck > 0 ? '+' : '') + entry.total_luck.toFixed(1)"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-right"
                                    :class="entry.weighted_luck < 0 ? 'text-red-600' : 'text-green-600'"
                                    x-text="(entry.weighted_luck > 0 ? '+' : '') + entry.weighted_luck.toFixed(1)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store chart instance outside Alpine to avoid reactivity issues
let luckChartInstance = null;

function luckAnalysis() {
    return {
        data: {},
        leaderboard: [],
        loading: true,
        rank: null,
        chartRendered: false,
        showModal: false,
        modalLoading: false,
        matchDetail: null,

        async init() {
            await Promise.all([
                this.fetchPlayerLuck(),
                this.fetchLeaderboard()
            ]);
            this.loading = false;
            // Wait for DOM to update after data load
            this.$nextTick(() => {
                setTimeout(() => this.renderChart(), 150);
            });
        },

        async fetchPlayerLuck() {
            try {
                const response = await fetch(`/api/luck/{{ username }}?season={{ season }}`);
                this.data = await response.json();
            } catch (e) {
                console.error('Failed to fetch luck data:', e);
            }
        },

        async fetchLeaderboard() {
            try {
                const response = await fetch(`/api/luck-leaderboard?season={{ season }}&rundle={{ rundle }}`);
                const result = await response.json();
                this.leaderboard = result.leaderboard || [];
                // Find rank
                const entry = this.leaderboard.find(e => e.username === '{{ username }}');
                if (entry) this.rank = entry.rank;
            } catch (e) {
                console.error('Failed to fetch leaderboard:', e);
            }
        },

        async showMatchDetail(matchDay) {
            this.showModal = true;
            this.modalLoading = true;
            this.matchDetail = null;

            try {
                const response = await fetch(`/api/match-detail/{{ username }}/${matchDay}?season={{ season }}`);
                if (response.ok) {
                    this.matchDetail = await response.json();
                } else {
                    console.error('Failed to fetch match detail:', response.status);
                }
            } catch (e) {
                console.error('Failed to fetch match detail:', e);
            }

            this.modalLoading = false;
        },

        get unluckyMatches() {
            if (!this.data.details) return [];
            return [...this.data.details].sort((a, b) => a.luck - b.luck).slice(0, 5);
        },

        get luckyMatches() {
            if (!this.data.details) return [];
            return [...this.data.details].sort((a, b) => b.luck - a.luck).slice(0, 5);
        },

        get rankColor() {
            if (!this.rank) return 'text-gray-900';
            const total = this.leaderboard.length;
            if (this.rank <= 3) return 'text-green-600';
            if (this.rank >= total - 2) return 'text-red-600';
            return 'text-gray-900';
        },

        renderChart() {
            // Prevent re-rendering
            if (this.chartRendered) {
                console.log('Chart already rendered, skipping');
                return;
            }

            if (!this.data.details || this.data.details.length === 0) {
                console.log('No data for chart');
                return;
            }

            const canvas = document.getElementById('luckChart');
            if (!canvas) {
                console.log('Canvas not found');
                return;
            }

            // Destroy existing chart if any
            if (luckChartInstance) {
                luckChartInstance.destroy();
            }

            // Sort by match day
            const sorted = [...this.data.details].sort((a, b) => a.match_day - b.match_day);

            // Calculate cumulative luck
            let cumulative = 0;
            const cumulativeData = sorted.map(m => {
                cumulative += m.luck;
                return Math.round(cumulative * 100) / 100;
            });

            console.log('Chart data:', cumulativeData);

            const lineColor = cumulativeData[cumulativeData.length - 1] < 0 ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)';
            const fillColor = cumulativeData[cumulativeData.length - 1] < 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)';

            luckChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sorted.map(m => 'Day ' + m.match_day),
                    datasets: [
                        {
                            label: 'Cumulative Luck',
                            data: cumulativeData,
                            borderColor: lineColor,
                            backgroundColor: fillColor,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: lineColor,
                            fill: true,
                            tension: 0.3,
                        },
                        {
                            label: 'Per-Match Luck',
                            data: sorted.map(m => m.luck),
                            borderColor: 'rgb(107, 114, 128)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: 'rgb(107, 114, 128)',
                            borderDash: [5, 5],
                            tension: 0.1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Luck Score' },
                            grid: {
                                color: (ctx) => ctx.tick.value === 0 ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            this.chartRendered = true;
            console.log('Chart rendered successfully');
        }
    };
}
</script>
{% endblock %}
